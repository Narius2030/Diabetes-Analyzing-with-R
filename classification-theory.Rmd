---
title: "ApDungCacMoHinhPhanTich"
author: "Nhom7_DuLieuVeTieuDuong"
date: "2023-12-13"
output: html_notebook
---

```{r}
#install.packages("readr")

```

```{r}
library(readr)
```

STEP-1 : Importing Diabetes Data from Google Drive

```{r}

# Đọc file CSV trực tiếp từ đường link
diabetes <- read_csv("https://drive.google.com/uc?id=15mjrv0LV2T6GWNdAuW-QhXVdtMkQALlh")
# Hiển thị dữ liệu
diabetes

```


```{r}
str(diabetes)
```



## Classifying the categories of Mass (BMI)

The World Health Organization (WHO) classifies adults based on the following BMI ranges:

* Underweight: < 18.5 kg/m^2

* Normal weight: 18.5 - 24.9 kg/m^2

* Overweight: 25.0 - 29.9 kg/m^2

* Obese: ≥ 30.0 kg/m^2

```{r}
library(ggplot2)
```


```{r}
diabetes$BMI_Category <- cut(diabetes$BMI, 
                             breaks = c(-Inf, 18.5, 24.9, 29.9, Inf), 
                             labels = c("Underweight", "Normal", "Overweight", "Obese"))

```


Trực quan phân bố của từng loại cân nặng

```{r}
ggplot(diabetes, aes(x = BMI_Category)) + 
  geom_bar(stat = "count") +
  labs(title = "Distribution of BMI Categories", x = "BMI Category", y = "Count") +
  theme_bw()

```

Tạo một dataframe bản sao với BMI_Category đã được số hóa

```{r}
num_diabetes <- diabetes

num_diabetes$BMI_Category <- cut(num_diabetes$BMI, 
                             breaks = c(-Inf, 18.5, 24.9, 29.9, Inf), 
                             labels = c(0, 1, 2, 3))
num_diabetes$BMI_Category <- as.integer(num_diabetes$BMI_Category)
```


Tìm các biến độc lập so với biến phụ thuộc BMI_Category

```{r}
library(lattice)
library(reshape2)

# creating correlation matrix
corr_mat <- round(cor(num_diabetes),2)
 
# reduce the size of correlation matrix
melted_corr_mat <- melt(corr_mat)
# head(melted_corr_mat)
 
# plotting the correlation heatmap
library(ggplot2)
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2, fill=value)) + geom_tile() +
  geom_text(aes(Var2, Var1, label = value), color = "white", size = 4)
```
Ta có thể thấy:

* So với BMI_Category, các thuộc tính BMI, Insulin, SkinThickness, BloodPressure và Glucose đều tương quan mạnh (5 thuộc tính)

* Vậy thuộc tính BMI_Category sẽ phụ thuộc nhiều vào chúng, ta có thể xem chúng là các biến độc lập


## **Xây mô hình Random Forest để phân loại cân nặng**

### Chia dữ liệu thành huấn luyện và kiểm tra. 80% dành cho đào tạo, 20% dành cho kiểm tra.

```{r}
set.seed(123)

samp <- sample(nrow(diabetes), 0.7 * nrow(diabetes))

train <- diabetes[samp, ]

test <- diabetes[-samp, ]
```

```{r}
#Kiểm tra kích thước của tập dữ liệu huấn luyện và kiểm tra
dim(train)
```

### Cách 1: Dùng kiểm định thông thường cho RF

```{r}
library(randomForest) 
```

#### Tìm giá trị tốt nhất cho tham số mtry bằng tuneRF

```{r}
rf_fit <- tuneRF(
  x = train[,-9],
  y = train$BMI_Category,
  metric = "OOBAcc",
  ntreeTry = 100,
  mtryStart = 3,
  stepFactor = 1.5,
  improve = 0.01,
  trace = T,
  plot = T
)
```

```{r}
# Lặp lại quá trình huấn luyện và đánh giá trên các giá trị khác nhau của ntree
error_out_of_bag <- c()
error_test <- c()
for (ntree in 1:100) {
    # Huấn luyện mô hình
    model <- randomForest(BMI_Category ~ . -DiabetesPedigreeFunction -Age -Outcome, data = train, ntree = ntree, mtry=3)

    # Tính lỗi ra ngoài túi
    error_out_of_bag[ntree] <- mean(predict(model, train) != train$BMI_Category)

    # Tính lỗi kiểm tra
    error_test[ntree] <- mean(predict(model, test) != test$BMI_Category)
}

# Vẽ đường cong lỗi
plot(error_out_of_bag, type = "l", col = "blue", ylab = "OOB error", xlab="Số cây trong rừng")
lines(error_test, type = "l", col = "red")
```


#### Huấn luyện mô hình

```{r}
model <- randomForest(BMI_Category ~ . -DiabetesPedigreeFunction -Age -Outcome, data = train, ntree = 10, mtry=3)

model
```

#### Xác thực mô hình của chúng tôi bằng cách sử dụng dữ liệu thử nghiệm

```{r}
prediction <- predict(model, newdata = test)

table(prediction, test$BMI_Category)
```

#### Hiển thị giá trị dự đoán so với giá trị thực tế

```{r}
results<-cbind(prediction,test$BMI_Category)

results

colnames(results)<-c('pred','real')

results<-as.data.frame(results)

View(results)
```

#### Tính độ chính xác của mô hình

```{r}
accuracy <- mean(prediction == test$BMI_Category)
accuracy
```

Bạn có thể thấy rằng độ chính xác của mô hình này là khoảng 98 phần trăm, điều này thật tuyệt vời. Bây giờ chúng tôi đã tự động hóa quá trình dự đoán loại cân nặng. Điều này đưa chúng ta đến khả năng theo dõi tình trạng sức khỏa của bệnh nhân và đưa ra chuẩn đoán sớm


### Cách 2: dùng cross-validation bằng thư viện caret

```{r}
library(caret)
```

#### Huấn luyện mô hình

```{r}
model_cv <- train(BMI_Category ~ . -DiabetesPedigreeFunction -Age -Outcome, data = train, method = "rf", metric = "Accuracy" ,trControl = trainControl(
              method = "cv",
              number = 5),
              search = "grid")

```

#### Xác thực mô hình trên tập kiểm tra

```{r}
pred <- predict(model_cv, newdata=test)

table(pred, test$BMI_Category)
```

#### Tính độ chính xác của mô hình

```{r}
accuracy <- mean(pred == test$BMI_Category)
accuracy
```



## **kiểm định giả thuyết thống kế**
### ****

### để chứng minh phần trăm mỡ trong cơ thẻ cũng ảnh hướng đến việc có mắc bệnh hay không

### *Cách 1: One-Sample T-test*
###giả thuyết BMI (Chỉ số khối cơ thể) trung bình 31 dễ mắc bệnh tiểu đường

```{r}
# Vẽ biểu đồ histogram
ggplot(diabetes, aes(x = BMI)) +
  geom_histogram(binwidth = 2, fill = "lightblue", color = "black") + 
  labs(x = "BMI", title = "Histogram of BMI") + theme_minimal() 

# summary statistics
kable(summary(select(diabetes, BMI)), format = "markdown")
```


###giả thuyết BMI trung bình mắc bệnh tiểu đường là 31

$$ 
H_0: bmi = 31
$$
$$ 
H_a: bmi \neq 31
$$
```{r}
t.test(diabetes$BMI, mu=31)
```

### Kết luận và giải thích
- Từ đầu ra và từ p.value chúng ta thấy rằng
- p-value nhỏ mức ý nghĩa 5%. 
- Giống như bất kỳ bài kiểm tra thống kê nào khác , nếu p-value nhỏ hơn mức ý nghĩa thì có thể bác bỏ giả thuyết.
--> Dựa vào kết quả kiểm định t-test, có thể kết luận rằng giá trị trung bình thực sự của cột "BMI" không bằng 31, và Ước lượng trung bình của mẫu có thể nằm trong khoảng từ 31.43410 đến 32.55106 với mức tin cậy 95%.

# -------------------------------------------
## **Cách 2: Independent Samples T-test**
### để chứng minh phần trăm mỡ trong cơ thẻ cũng ảnh hướng đến việc có mắc bệnh hay không
### giả thuyết lượng mỡ trong cơ thể (BMI) không ảnh hưởng đến việc có bệnh hay không

```{r}
# Vẽ biểu đồ histogram
ggplot(diabetes, aes(x = BMI_Category)) + 
  geom_bar(stat = "count") + 
  labs(title = "Distribution of BMI Categories", x = "BMI Category", y = "Count") + 
  theme_bw()
```


###giả thuyết tỳ lệ BMI của người bệnh và không bệnh là như nhau
$$ 
H_0: bmi_0 = bmi_1
$$
$$ 
H_a: bmi_0 \neq bmi_1
$$
```{r}
#lấy ra những người bệnh và không bệnh có chỉ số BMI_Category >= 3
sick <- num_diabetes[num_diabetes$Outcome==1 & num_diabetes$BMI_Category >= 3,10]
normal <- num_diabetes[num_diabetes$Outcome==0 & num_diabetes$BMI_Category >= 3,10]

t.test(normal,sick,var.equal=FALSE)
```

### Kết luận và giải thích
- Từ đầu ra và từ p.value chúng ta thấy rằng
- p-value nhỏ mức ý nghĩa 5%. 
- Giống như bất kỳ bài kiểm tra thống kê nào khác , nếu p-value nhỏ hơn mức ý nghĩa thì có thể bác bỏ giả thuyết.
--> Dựa vào kết quả kiểm định t-test, có thể kết luận rằng lượng mỡ trong cơ thể có ảnh hưởng đến việc người đó có bệnh tiểu đường .


## *để chứng minh độ tuổi cũng ảnh hưởng đến việc người đó có bị bệnh tiểu đường hay không.*
### giả thuyết độ tuổi trung bình mắc bệnh tiểu đường là 32

```{r}
# Vẽ biểu đồ histogram
ggplot(diabetes, aes(x = Age)) +
  geom_histogram(binwidth = 2, fill = "lightblue", color = "black") +
  labs(x = "Age", title = "Histogram of Age") +
  theme_minimal()

# summary statistics
kable(summary(select(diabetes, Age)), format = "markdown")
```


###giả thuyết độ tuổi trung bình mắc bệnh tiểu đường là 32

$$ 
H_0: age = 32
$$
$$ 
H_a: age \neq 32
$$

```{r}
t.test(diabetes$Age, mu=32)
```

### Kết luận và giải thích
- Từ đầu ra và từ p.value chúng ta thấy rằng
- p-value nhỏ mức ý nghĩa 5%. 
- Giống như bất kỳ bài kiểm tra thống kê nào khác , nếu p-value nhỏ hơn mức ý nghĩa thì có thể bác bỏ giả thuyết không.
--> Dựa vào kết quả kiểm định t-test, có thể kết luận rằng giá trị trung bình thực sự của cột "Age" không bằng 32, và Ước lượng trung bình của mẫu có thể nằm trong khoảng từ 32.41 đến 34.07 với mức tin cậy 95%.


