---
title: "Logistic_Regressio"
author: "Thien Nhan"
date: "2023-12-13"
output: html_document
---

```{r setup, include=FALSE}
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = TRUE)
```

# ANALYST DIABETES DATASET

## Import library

```{r}
library(dplyr)
library(readr)
```

## Import dataset

```{r}
# Đọc file CSV trực tiếp từ đường link
df <- read_csv("https://drive.google.com/uc?id=15mjrv0LV2T6GWNdAuW-QhXVdtMkQALlh")
# Hiển thị dữ liệu
head(df)
```

```{r}
colnames(df)
```

```{r}
str(df)
```

```{r}
summary(df)
```

```{r}
sapply (df, sd)
```

## Trực quan hóa

```{r}
library(ggplot2)
```


```{r}
# Tạo biểu đồ cột
outcome_counts <- table(df$Outcome)
barplot(outcome_counts, main = "Tỷ lệ bệnh tiểu đường", xlab = "Outcome", ylab = "Số lượng", col = c("green", "red"))

# Tạo chú thích
legend("topright", legend = c("Không có bệnh", "Có bệnh"), fill = c("green", "red"))


# Tính phần trăm
percentages <- round(prop.table(outcome_counts) * 100, 1)

# Tạo biểu đồ tròn
pie(outcome_counts, main = "Tỷ lệ bệnh tiểu đường", labels = paste(percentages, "%"), col = c("lightgreen", "lightcoral"))

# Tạo chú thích
legend("topright", legend = c("Không có bệnh", "Có bệnh"), fill = c("green", "red"))
```

## Ma trận tương quan

```{r}
library(corrgram)
```

```{r}
corrgram(df)
```

Xét biểu đồ tương quan, ta thấy:<br>
- Pregnancies và Age tương quan cao<br>
- SkinThickness và Insulin tương quan cao<br>

Do đó: Khi xây dựng mô hình dự đoán, với mỗi cặp thuộc tính, chỉ sử dụng 1 trong 2 để hạn chế tình trạng đa cộng tuyến (multicollinearity)



## Xây dựng các mô hình

### Chia tập dữ liệu thành 2 tập train và test

```{r}
library(caret)
```

```{r}
set.seed(1)
split <- createDataPartition(df$Outcome,p = 0.75,list = FALSE)
dfTrain <- df[split,]
dfTest <- df[-split,]
```

```{r}
head(dfTrain)
```

```{r}
head(dfTest)
```

#### Hàm kiểm tra mô hình

```{r}
# Dùng ma trận nhầm lẫn
accuracy <- function() {
  predictions <- predict(model, newdata = dfTest, type = "class")
  
  # So sánh giữa giá trị dự đoán và giá trị thực tế
  confusion_matrix <- table(predictions, dfTest$Outcome)
  print(confusion_matrix)
  
  # Tính toán độ chính xác từ ma trận nhầm lẫn
  accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
  return (accuracy)
}
```


### Xây dựng mô hình cây quyết định 

#### Tính entropy cho các thuộc tính
```{r}
# Tính entropy cho từng cột trong dfTrain
# Hàm tính entropy
calculate_entropy <- function(attribute_vector) {
  total_count <- length(attribute_vector)
  values <- table(attribute_vector)
  probabilities <- values / total_count
  entropy <- -sum(probabilities * log2(probabilities))
  return(entropy)
}

calculate_entropy_for_columns <- function(data) {
  entropy_values <- numeric()
  for (col in names(data)) {
    entropy <- calculate_entropy(data[[col]])
    entropy_values <- c(entropy_values, entropy)
  }
  names(entropy_values) <- names(data)
  return(entropy_values)
}

# Tính entropy cho các cột trong dfTrain
entropy_values <- calculate_entropy_for_columns(dfTrain)
entropy_values

```


#### Xây dựng mô hình cây quyết định
```{r}
# Huấn luyện mô hình cây quyết định
library(rpart)
model <- rpart(Outcome ~ Pregnancies + Glucose + BloodPressure + SkinThickness + Insulin + BMI + DiabetesPedigreeFunction + Age, data = dfTrain, method = "class")

# In cây quyết định
print(model)

# Biểu đồ cây quyết định
library(rpart.plot)
rpart.plot(model)
```

##### Xem độ quan trọng của các thuộc tính trong mô hình
```{r}
library(vip)
var_importance <- vip::vip(model, num_features = 10)
print(var_importance)
```


```{r}
library(pdp)
library(ggplot2)

# Lặp qua từng cột trong dfTrain (loại bỏ cột mục tiêu)
for (col in names(dfTrain)[-ncol(dfTrain)]) {
  # Tạo Partial Dependence Plot cho từng cột và lưu vào biến pdp_plot
  pdp_plot <- partial(model, pred.var = col)
  
  # Tạo biểu đồ Partial Dependence Plot và hiển thị
  plot(pdp_plot, main = paste("Partial Dependence Plot for", col))
}

```
Dựa vào biểu đồ mức độ quan trọng của các thuộc tính trong mô hình ta thấy rằng: <br>
  - Các thuộc tính Pregnancies, BloodPressure, SkinThickness, Insulin có trọng số thấp nhất. <br>
Dựa vào Partial Dependence Plot (PDP) - Biểu đồ phụ thuộc một phần thấy rằng:<br>
  - Các thuộc tính Pregnancies, BloodPressure, SkinThickness, Insulin tăng lên nhưng không ảnh hưởng đến kết quả dự đoán của mô hình.<br>
  
#### Loại bỏ các thuộc tính trên (Pregnancies, SkinThickness, Insulin)
##### Loại bỏ Insulin
```{r}
model <- rpart(Outcome ~ Pregnancies + Glucose + BloodPressure + SkinThickness + BMI + DiabetesPedigreeFunction + Age, data = dfTrain, method = "class")
accuracy()
```
##### Loại bỏ Insulin và SkinThickness và Pregnancies
```{r}
model <- rpart(Outcome ~ Glucose + BloodPressure + BMI + DiabetesPedigreeFunction + Age, data = dfTrain, method = "class")
rpart.plot(model)
accuracy()
```
#### Trích xuất các luật từ cây quyết định
```{r}
rules <- rpart.rules(model)
print(rules)
```



